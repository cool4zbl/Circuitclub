{{!-- header.hbs --}}
<style>
  .warning {
    color: red;
  }
</style>


<nav role="navigation" style="margin-bottom: 0" class="navbar navbar-default navbar-fixed-top">
  <div class="navbar-header">
    <button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle">
      <span class="sr-only">Toggle navigation</span>                   
      <span class="icon-bar"></span>                    
      <span class="icon-bar"></span>                    
      <span class="icon-bar"></span>
    </button>  
    <a href="/" class="navbar-brand">电路分析考试系统</a>
    <ul class="nav navbar-nav navbar-right">
      <li class="active">
        {{#if user}}
          <li><a href="/logout">退出</a></li>
        {{ else }}  
          <li><a href="#" data-toggle="modal" data-target="#loginModal">登录</a></li>
          <li><a href="#" data-toggle="modal" data-target="#signupModal">注册</a></li>
        {{/if}}
      </li>
    </ul>
  </div>  
</nav>
{{!-- 登录modal --}}
<div id="loginModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" data-dismiss="modal" class="close"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
          <h4 id="loginLabel" class="modal-title">登录</h4>
        </div>
        <div class="modal-body">
          <form method="post" action="/login" class="form-horizontal">
            <filedset>
              <div class="form-group">
                <label for="login-username" class="control-label col-sm-4">用户名</label>
                <div class="col-sm-8">
                  <input id="login-username" type="text" name="username" placeholder="请输入您的学号" class="form-control"/>
                </div>
              </div>
              <div class="form-group">
                <label for="login-password" class="control-label col-sm-4">密码</label>
                <div class="col-sm-8">
                  <input id="log-inpassword" type="password" name="password" placeholder="请输入您的密码" class="form-control"/>
                </div>
              </div>
            </filedset>
            <div class="modal-footer">
              <button id="login" type="button" onclick="javascript:$('.form-horizontal').submit()" class="btn btn-primary">登录</button>
              <button type="button" data-dismiss="modal" class="btn btn-default">取消</button>
            </div>
          </form>
        </div>
      </div>
    </div>
</div>
{{!-- 注册modal --}}
<div id="signupModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" data-dismiss="modal" class="close closeModal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
          <h4 id="signupLabel" class="modal-title">注册</h4>
        </div>
        <div class="modal-body">
          <form method="post" action="/signup" class="form-horizontal" enctype="" >
            <filedset>
              <div class="form-group">
                <label for="signup-username" class="control-label col-sm-4">用户名</label>
                <div class="col-sm-8">
                  <input id="signup-username" type="text" name="user[username]" placeholder="请输入您的学号" class="form-control"/>
                  <span class="fade warning">请输入正确的学号！</span>

                </div>
              </div>
              <div class="form-group">
                <label for="signup-password" class="control-label col-sm-4">密码</label>
                <div class="col-sm-8">
                  <input id="signup-password" type="password" name="user[password]" placeholder="长度不小于8位" class="form-control"/>
                </div>
              </div>              
              <div class="form-group">
                <label for="signup-password-repeat" class="control-label col-sm-4">重复密码</label>
                <div class="col-sm-8">
                  <input id="signup-password-repeat" type="password" name="password" placeholder="请再次输入密码" class="form-control"/>
                  <span class="fade warning">两次密码不一致！</span>
                  {{!-- <span class="fade warning">棉麻长度至少8位！</span> --}}

                </div>
              </div>
            </filedset>
            <div class="modal-footer">
              <button id="signup" type="submit" class="btn btn-primary">注册</button>
              <button type="button" data-dismiss="modal" class="btn btn-default closeModal">取消</button>
            </div>
          </form>
        </div>
      </div>
    </div>
</div>

<script>
  $(document).ready(function() {
    var $signName = $('#signup-username');
    var $signPwd = $('#signup-password');
    var $signpwdRp = $('#signup-password-repeat');
    var regexp = /^[0-9]{13}$/g;
    $('button.closeModal').click(function(event) {
      $('input').val('');
    });

    $('#signupModal').on('submit', function(event) {
      event.preventDefault();
      var username = $signName.val(); 
      var pwd = $signPwd.val(), pwdRp = $signpwdRp.val();
       // 发送至服务器的数据
      var data = {
        username: username,
        password: pwd
      };
      if (!username.match(regexp)) {
        $signName.next().removeClass('fade');
      } else {
        $signName.next().addClass('fade');        
      }
      if ( pwd !== pwdRp) {
        $signpwdRp.next().removeClass('fade');
      } else {
        $signpwdRp.next().addClass('fade');
      }
      if ( username.match(regexp) && pwd === pwdRp) {
        // 2011029050016
        
       $.ajax({
        url: '/signup',
        type: 'POST',
        data: JSON.stringify(data),   // 发送至服务器的数据
        contentType: 'application/json',
      })
      .done(function(res) {
        console.log("success");
        console.log(res);
        if (res.err === 1) {
          $signName.next().removeClass('fade')
                          .text('用户名已被占用');
        }
      })
      .fail(function() {
        console.log("error");
      })
      .always(function() {
        console.log("complete");
      });
      }

      
    });

  });
</script>